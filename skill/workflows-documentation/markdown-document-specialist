#!/bin/bash
# ───────────────────────────────────────────────────────────────
# COMPONENT: MARKDOWN DOCUMENT SPECIALIST CLI
# ───────────────────────────────────────────────────────────────
#
# Script-assisted AI analysis CLI tool.
#
# Commands:
#   extract <file.md>     - Extract document structure as JSON for AI analysis
#   validate <skill-path> - Quick validation of skill frontmatter
#   init <name> --path    - Initialize new skill from template
#   package <path>        - Package skill into distributable zip
#
# The extract command outputs structured JSON that AI agents use
# for document analysis. Scripts handle parsing/metrics, AI handles judgment.
#
# ───────────────────────────────────────────────────────────────

set -euo pipefail

# Get script directory (resolves symlinks)
SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}" 2>/dev/null || echo "${BASH_SOURCE[0]}")")" && pwd)"
EXTRACT_SCRIPT="$SCRIPT_DIR/scripts/extract_structure.py"
INIT_SKILL_SCRIPT="$SCRIPT_DIR/scripts/init_skill.py"
PACKAGE_SKILL_SCRIPT="$SCRIPT_DIR/scripts/package_skill.py"
VALIDATE_SKILL_SCRIPT="$SCRIPT_DIR/scripts/quick_validate.py"

# Check Python3 availability
if ! command -v python3 >/dev/null 2>&1; then
    echo "Error: python3 not found. Install Python 3 to use markdown-document-specialist." >&2
    exit 1
fi

# Show usage
show_usage() {
    cat << 'EOF'
markdown-document-specialist - Script-assisted AI document analysis

USAGE:
    markdown-document-specialist <command> [options]

COMMANDS:
    extract <file.md>              Extract document structure + DQI score as JSON
    validate <skill-path> [--json] Quick validation of skill directory
    init <name> --path <dir>       Initialize new skill from template
    package <path> [output-dir]    Package skill into distributable zip

EXAMPLES:
    # Extract structure for AI analysis
    markdown-document-specialist extract SKILL.md
    markdown-document-specialist extract README.md

    # Validate a skill
    markdown-document-specialist validate .opencode/skills/my-skill
    markdown-document-specialist validate .opencode/skills/my-skill --json

    # Create and package skills
    markdown-document-specialist init my-skill --path .opencode/skills
    markdown-document-specialist package .opencode/skills/my-skill

WORKFLOW:
    1. Run 'extract' to get structured JSON output
    2. AI reads JSON and evaluates content quality
    3. AI generates recommendations based on checklist results

For full documentation, see:
    .opencode/skills/workflows-documentation/SKILL.md
    .opencode/skills/workflows-documentation/references/workflows.md
EOF
}

# Parse command line
case "${1:-}" in
    --help|-h|help)
        show_usage
        exit 0
        ;;
    
    extract)
        # Extract document structure as JSON
        if [[ $# -lt 2 ]]; then
            echo "Error: extract requires a file path" >&2
            echo "Usage: markdown-document-specialist extract <file.md>" >&2
            exit 1
        fi

        if [[ ! -f "$EXTRACT_SCRIPT" ]]; then
            echo "Error: extract_structure.py not found at $EXTRACT_SCRIPT" >&2
            exit 1
        fi

        shift
        python3 "$EXTRACT_SCRIPT" "$@"
        ;;
    
    validate|--validate-skill)
        # Validate skill directory
        if [[ $# -lt 2 ]]; then
            echo "Error: validate requires a skill path" >&2
            echo "Usage: markdown-document-specialist validate <skill-path> [--json]" >&2
            exit 1
        fi

        if [[ ! -f "$VALIDATE_SKILL_SCRIPT" ]]; then
            echo "Error: quick_validate.py not found at $VALIDATE_SKILL_SCRIPT" >&2
            exit 1
        fi

        shift
        python3 "$VALIDATE_SKILL_SCRIPT" "$@"
        ;;
    
    init|--init-skill)
        # Initialize new skill
        if [[ $# -lt 2 ]]; then
            echo "Error: init requires skill name" >&2
            echo "Usage: markdown-document-specialist init <skill-name> --path <dir>" >&2
            exit 1
        fi

        if [[ ! -f "$INIT_SKILL_SCRIPT" ]]; then
            echo "Error: init_skill.py not found at $INIT_SKILL_SCRIPT" >&2
            exit 1
        fi

        shift
        python3 "$INIT_SKILL_SCRIPT" "$@"
        ;;
    
    package|--package-skill)
        # Package skill
        if [[ $# -lt 2 ]]; then
            echo "Error: package requires skill path" >&2
            echo "Usage: markdown-document-specialist package <skill-path> [output-dir]" >&2
            exit 1
        fi

        if [[ ! -f "$PACKAGE_SKILL_SCRIPT" ]]; then
            echo "Error: package_skill.py not found at $PACKAGE_SKILL_SCRIPT" >&2
            exit 1
        fi

        shift
        python3 "$PACKAGE_SKILL_SCRIPT" "$@"
        ;;
    
    --*)
        echo "Error: Unknown option '$1'" >&2
        echo "Try 'markdown-document-specialist --help' for usage" >&2
        exit 1
        ;;
    
    "")
        echo "Error: No command specified" >&2
        echo "Usage: markdown-document-specialist <command> [options]" >&2
        echo "Try 'markdown-document-specialist --help' for more information" >&2
        exit 1
        ;;
    
    *)
        # Check if it's a .md file - default to extract
        if [[ "$1" == *.md ]]; then
            if [[ ! -f "$EXTRACT_SCRIPT" ]]; then
                echo "Error: extract_structure.py not found at $EXTRACT_SCRIPT" >&2
                exit 1
            fi
            python3 "$EXTRACT_SCRIPT" "$@"
        else
            echo "Error: Unknown command '$1'" >&2
            echo "Try 'markdown-document-specialist --help' for usage" >&2
            exit 1
        fi
        ;;
esac
