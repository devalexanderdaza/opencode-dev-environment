# ───────────────────────────────────────────────────────────────────
# SMART SPECKIT: DEBUG DELEGATION WORKFLOW (AUTONOMOUS MODE)
# ───────────────────────────────────────────────────────────────────
role: Expert Developer using Debug Delegation for Persistent Issues
purpose: Delegate debugging to fresh sub-agent with complete context handoff
action: Run 5-step debug workflow from context validation through integration

operating_mode:
  workflow: sequential_5_step
  workflow_compliance: MANDATORY
  workflow_execution: autonomous
  approvals: model_selection_only
  tracking: debug_report_creation
  validation: sub_agent_response_check

debug_philosophy:
  principle: "Fresh perspective solves stuck problems"
  approach: "Systematic escalation with context preservation"
  mandate: "Gather context, select model, dispatch, synthesize findings"

# ───────────────────────────────────────────────────────────────────
# USER INPUTS (Collected during phases in debug.md)
# ───────────────────────────────────────────────────────────────────
user_inputs:
  spec_path:
    source: "Phase 1 of debug.md"
    description: "Spec folder path for the debugging context"
    required: true

  detection_method:
    source: "Phase 1 of debug.md"
    description: "How spec folder was detected"
    values: [recent, provided, ad-hoc]

  error_message:
    source: "Phase 1 of debug.md"
    description: "Error message or unexpected behavior being debugged"
    required: true

  affected_files:
    source: "Phase 1 of debug.md"
    description: "List of files involved in the error"

  previous_attempts:
    source: "Phase 1 of debug.md"
    description: "Previous fix attempts and their outcomes"

  selected_model:
    source: "Phase 2 of debug.md"
    description: "AI model selected for debug delegation"
    values: [claude, gemini, codex, other]
    required: true

# ───────────────────────────────────────────────────────────────────
# FIELD HANDLING
# ───────────────────────────────────────────────────────────────────
field_handling:
  defaults:
    affected_files_empty: "Infer from error message and conversation"
    previous_attempts_empty: "Document as 'First delegation attempt'"

  validation:
    spec_path_required: true
    error_message_required: true
    selected_model_required: true

# ───────────────────────────────────────────────────────────────────
# MODEL SELECTION REFERENCE
# ───────────────────────────────────────────────────────────────────
model_selection:
  note: "Selection happens in Phase 2 of debug.md"
  options:
    - id: claude
      name: "Claude - Anthropic models"
      strengths: "Code analysis, systematic debugging"
    - id: gemini
      name: "Gemini - Google models"
      strengths: "Alternative perspective, broad knowledge"
    - id: codex
      name: "Codex - OpenAI models"
      strengths: "Complex reasoning, code generation"
    - id: other
      name: "Other - User specified"

# ───────────────────────────────────────────────────────────────────
# AVAILABLE TEMPLATES
# ───────────────────────────────────────────────────────────────────
available_templates:
  debug_delegation: .opencode/skill/system-spec-kit/templates/debug-delegation.md
  universal_debugging: .opencode/skill/system-spec-kit/references/debugging/universal_debugging_methodology.md

# ───────────────────────────────────────────────────────────────────
# WORKFLOW ENFORCEMENT (CRITICAL)
# ───────────────────────────────────────────────────────────────────
workflow_enforcement:
  mode: strict
  step_order: sequential_mandatory
  skip_allowed: false

  step_completion_rule: |
    FOR EACH STEP:
    1. Execute ALL activities listed
    2. Verify ALL outputs exist
    3. Mark step ✅ in tracking
    4. ONLY THEN proceed to next step
    
    ⛔ NEVER skip a step
    ⛔ NEVER dispatch without debug-delegation.md created
    ⛔ NEVER apply fixes without Gate 3 check (if ad-hoc mode)

  critical_steps:
    step_2_generate_report:
      enforcement: "MUST create debug-delegation.md before dispatch"
      verification: "File exists in spec folder or scratch/"
    step_5_integration:
      enforcement: "MUST check Gate 3 before applying fixes in ad-hoc mode"

# ───────────────────────────────────────────────────────────────────
# WORKFLOW (5 STEPS)
# ───────────────────────────────────────────────────────────────────
workflow:
  step_1_validate_context:
    purpose: Confirm all required context is available from phases
    activities:
      - Verify spec_path exists and is accessible
      - Verify error_message is captured
      - Verify affected_files are identified
      - Verify previous_attempts are documented
      - Note reproduction_steps (optional but helpful)
    if_context_missing:
      action: "Report what's missing and return to Phase 1"
    outputs:
      - context_confirmed: true
    validation: all_required_context_available

  step_2_generate_report:
    purpose: Create debug-delegation.md using template
    template: .opencode/skill/system-spec-kit/templates/debug-delegation.md
    activities:
      - Read template
      - Fill all placeholders with phase outputs
      - Generate task_id as debug-YYYYMMDD-HHMM
      - Classify error_category from error message
      - Document all previous_attempts
      - Add hypothesis about root cause
      - Save file to spec folder or scratch/
    error_categories:
      syntax_error: "Parse errors, unexpected tokens, brackets"
      type_error: "Type mismatch, undefined properties, TS errors"
      runtime_error: "Exceptions during execution, crashes"
      test_failure: "Assertion failures, test timeouts"
      build_error: "Compilation failures, bundling errors"
      lint_error: "Linter errors, code style violations"
      unknown: "Cannot classify from error message"
    save_location:
      with_spec: "[spec_path]/debug-delegation.md"
      ad_hoc: "scratch/debug-delegation.md"
    outputs:
      - debug_delegation_md: "[path to created file]"
    validation: file_created_successfully

  step_3_dispatch_subagent:
    purpose: Dispatch @debug agent with structured handoff via Task tool
    agent: "@debug"
    agent_file: ".opencode/agent/debug.md"
    task_parameters:
      description: "Debug: [brief error summary - max 50 chars]"
      subagent_type: "debug"
      prompt: "[sub_agent_prompt_template]"
    sub_agent_prompt_template: |
      # Debug Agent Dispatch

      You are the @debug agent. Execute your 4-phase debugging methodology:
      OBSERVE → ANALYZE → HYPOTHESIZE → FIX

      ## Debug Context Handoff

      ### Error Description
      {error_message}

      ### Files Involved
      {affected_files}

      ### Reproduction Steps
      {reproduction_steps}

      ### Prior Attempts (What Was Tried)
      {previous_attempts}

      ### Environment
      - Model: {selected_model}
      - Spec Folder: {spec_path}

      ## Instructions
      - Follow your 4-phase methodology exactly
      - Form 2-3 ranked hypotheses with evidence
      - Make minimal, targeted fixes
      - Return structured response (Success/Blocked/Escalation format)

      ## Full Debug Report
      {debug_delegation_md_content}
    fallback:
      subagent_type: "general-purpose"  # Claude Code: "general-purpose" | OpenCode: "general"
      fallback_reason: "If @debug agent file unavailable or dispatch fails"

      ### Verification
      1. [Step 1]
      2. [Step 2]
      3. [Step 3]
      
      ### Prevention
      [How to prevent this issue in future]
      
      ### Caveats
      [Any assumptions or uncertainties]
    timeout_ms: 120000
    outputs:
      - sub_agent_dispatched: true
    validation: task_tool_invoked

  step_4_receive_findings:
    purpose: Capture and validate sub-agent response
    activities:
      - Wait for sub-agent response
      - Extract root_cause, proposed_fix, verification_steps, prevention
      - Validate proposed_fix includes file paths and executable code
      - Store findings for integration
    if_response_received:
      extract: [root_cause, proposed_fix, verification_steps, prevention, caveats]
      validate: "proposed_fix includes file paths and executable code"
    if_timeout_or_error:
      action: "Offer retry options (A/B/C)"
    if_needs_more_context:
      action: "Gather additional context and re-dispatch"
    retry_limit: 3
    outputs:
      - findings_received: true
      - root_cause: "[from sub-agent]"
      - proposed_fix: "[from sub-agent]"
    validation: valid_findings_captured

  step_5_integration:
    purpose: Present findings and apply resolution
    activities:
      - Display findings summary to user
      - Present integration options (A/B/C/D)
      - Handle user selection
      - Apply fix if requested (with Gate 3 check)
      - Update debug-delegation.md with resolution
    integration_options:
      A_apply_fix:
        label: "Apply the fix"
        gate_3_check: "IF ad-hoc mode: Ask spec folder question"
        actions: [make_code_changes, verify_changes, suggest_tests, update_report]
        status: "RESOLVED"
      B_show_details:
        label: "Show full details"
        actions: [display_full_response, re_ask_for_action]
      C_more_investigation:
        label: "Request more investigation"
        actions: [ask_focus_area, re_dispatch_subagent]
      D_manual_review:
        label: "Manual review"
        actions: [confirm_user_handles, keep_report]
        status: "NEEDS_REVIEW"
    resolution_section: |
      ## 6. RESOLUTION
      **Resolved By:** Sub-agent delegation
      **Resolution Date:** [timestamp]
      **Root Cause:** [from sub-agent]
      **Fix Applied:** [description]
      **Verified:** [yes/no + method]
    outputs:
      - resolution_complete: true
      - status: "[RESOLVED|NEEDS_REVIEW|ESCALATE]"
    validation: user_action_completed

# ───────────────────────────────────────────────────────────────────
# WORKFLOW TERMINATION
# ───────────────────────────────────────────────────────────────────
termination:
  after_step: 5
  message: "Debug delegation completed."
  next_steps:
    - condition: "Fix applied successfully"
      action: "Verify in browser/tests"
    - condition: "Fix applied, continue work"
      action: "Return to original workflow"
    - condition: "Issue needs more analysis"
      action: "/spec_kit:debug (retry with different model)"
    - condition: "Want to save debugging context"
      action: "/memory:save [spec-folder-path]"
    - condition: "Debugging session complete"
      action: "/spec_kit:handover [spec-folder-path]"
  always_end_with: "What would you like to do next?"

# ───────────────────────────────────────────────────────────────────
# AUTONOMOUS EXECUTION GUIDANCE
# ───────────────────────────────────────────────────────────────────
autonomous_execution:
  principle: "Execute debug delegation with minimal user interaction after phases complete"
  decision_making:
    - Gather full context from phase outputs
    - Generate comprehensive debug report
    - Dispatch with complete context
    - Present findings clearly for user decision
  validation_approach:
    - Verify all context available before dispatch
    - Validate sub-agent response quality
    - Confirm fix addresses original issue

# ───────────────────────────────────────────────────────────────────
# ERROR RECOVERY
# ───────────────────────────────────────────────────────────────────
error_recovery:
  context_incomplete:
    action: "Return to Phase 1 to gather missing context"
  report_creation_fails:
    action: "Verify template exists, retry with simplified report"
  sub_agent_timeout:
    action: "Offer retry with same or different model"
  sub_agent_needs_context:
    action: "Gather requested context, re-dispatch"
  fix_application_fails:
    action: "Present error, offer manual review option"
  max_retries_exceeded:
    action: "Set status to ESCALATE, suggest manual debugging"

# ───────────────────────────────────────────────────────────────────
# RULES
# ───────────────────────────────────────────────────────────────────
rules:
  ALWAYS:
    - verify_context_from_phases
    - create_debug_delegation_md_before_dispatch
    - include_full_context_in_dispatch
    - validate_sub_agent_response
    - check_gate_3_before_applying_fixes_in_adhoc_mode
    - update_debug_delegation_md_with_resolution

  NEVER:
    - dispatch_without_debug_report
    - apply_fixes_without_user_confirmation
    - skip_gate_3_check_in_adhoc_mode
    - exceed_retry_limit_without_escalation
