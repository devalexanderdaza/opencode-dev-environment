# ───────────────────────────────────────────────────────────────────
# SMART SPECKIT: DEBUG DELEGATION WORKFLOW (INTERACTIVE MODE)
# ───────────────────────────────────────────────────────────────────
role: Expert Developer using Debug Delegation with User Checkpoints
purpose: Delegate debugging to fresh sub-agent with user approval at each step
action: Run 5-step debug workflow with checkpoints for user validation

operating_mode:
  workflow: sequential_5_step
  workflow_compliance: MANDATORY
  workflow_execution: interactive
  approvals: step_by_step
  tracking: debug_report_creation
  validation: checkpoint_based

debug_philosophy:
  principle: "Fresh perspective solves stuck problems"
  approach: "Systematic escalation with user validation at checkpoints"
  mandate: "Gather context, confirm with user, dispatch, synthesize findings"

# ───────────────────────────────────────────────────────────────────
# USER INPUTS (Collected during phases in debug.md)
# ───────────────────────────────────────────────────────────────────
user_inputs:
  spec_path:
    source: "Phase 1 of debug.md"
    description: "Spec folder path for the debugging context"
    required: true

  detection_method:
    source: "Phase 1 of debug.md"
    description: "How spec folder was detected"
    values: [recent, provided, ad-hoc]

  error_message:
    source: "Phase 1 of debug.md"
    description: "Error message or unexpected behavior being debugged"
    required: true

  affected_files:
    source: "Phase 1 of debug.md"
    description: "List of files involved in the error"

  previous_attempts:
    source: "Phase 1 of debug.md"
    description: "Previous fix attempts and their outcomes"

  selected_model:
    source: "Phase 2 of debug.md"
    description: "AI model selected for debug delegation"
    values: [claude, gemini, codex, other]
    required: true

# ───────────────────────────────────────────────────────────────────
# FIELD HANDLING
# ───────────────────────────────────────────────────────────────────
field_handling:
  defaults:
    affected_files_empty: "Infer from error message and conversation"
    previous_attempts_empty: "Document as 'First delegation attempt'"

  validation:
    spec_path_required: true
    error_message_required: true
    selected_model_required: true

# ───────────────────────────────────────────────────────────────────
# MODEL SELECTION REFERENCE
# ───────────────────────────────────────────────────────────────────
model_selection:
  note: "Selection happens in Phase 2 of debug.md"
  options:
    - id: claude
      name: "Claude - Anthropic models"
      strengths: "Code analysis, systematic debugging"
    - id: gemini
      name: "Gemini - Google models"
      strengths: "Alternative perspective, broad knowledge"
    - id: codex
      name: "Codex - OpenAI models"
      strengths: "Complex reasoning, code generation"
    - id: other
      name: "Other - User specified"

# ───────────────────────────────────────────────────────────────────
# AVAILABLE TEMPLATES
# ───────────────────────────────────────────────────────────────────
available_templates:
  debug_delegation: .opencode/skill/system-spec-kit/templates/debug-delegation.md
  universal_debugging: .opencode/skill/system-spec-kit/references/debugging/universal_debugging_methodology.md

# ───────────────────────────────────────────────────────────────────
# MULTI-AGENT DISPATCH CONFIGURATION
# ───────────────────────────────────────────────────────────────────
multi_agent_config:
  enabled: true

  dispatch_modes:
    single:
      id: A
      label: "Single Agent"
      description: "Execute with one primary agent (default)"
      agent_count: 1
      model: "opus"

    multi_small:
      id: B
      label: "Multi-Agent (1+2)"
      description: "1 orchestrator + 2 parallel workers"
      orchestrator:
        model: "opus"
        role: "coordinator"
        responsibilities:
          - "Execute OBSERVE phase (read error, categorize, map scope)"
          - "Synthesize worker hypothesis outputs"
          - "Execute FIX phase (minimal change, verify)"
          - "Generate final resolution report"
      workers:
        - model: "sonnet"
          role: "call_path_tracer"
          focus: "Execution Path Analysis"
          phase: "ANALYZE"
          responsibilities:
            - "Trace call paths to error location"
            - "Understand data flow through affected code"
            - "Check for recent changes (git)"
            - "Map execution sequence"
        - model: "sonnet"
          role: "pattern_searcher"
          focus: "Similar Working Code"
          phase: "ANALYZE"
          responsibilities:
            - "Find similar patterns that work correctly"
            - "Identify differences between working and broken code"
            - "Search for related implementations"
            - "Document reference patterns"

    multi_large:
      id: C
      label: "Multi-Agent (1+3)"
      description: "1 orchestrator + 3 parallel workers"
      orchestrator:
        model: "opus"
        role: "coordinator"
        responsibilities:
          - "Execute OBSERVE phase (read error, categorize, map scope)"
          - "Synthesize worker hypothesis outputs"
          - "Execute FIX phase (minimal change, verify)"
          - "Generate final resolution report"
      workers:
        - model: "sonnet"
          role: "call_path_tracer"
          focus: "Execution Path Analysis"
          phase: "ANALYZE"
          responsibilities:
            - "Trace call paths to error location"
            - "Understand data flow through affected code"
            - "Check for recent changes (git)"
            - "Map execution sequence"
        - model: "sonnet"
          role: "pattern_searcher"
          focus: "Similar Working Code"
          phase: "ANALYZE"
          responsibilities:
            - "Find similar patterns that work correctly"
            - "Identify differences between working and broken code"
            - "Search for related implementations"
            - "Document reference patterns"
        - model: "sonnet"
          role: "edge_case_hunter"
          focus: "Boundary Conditions"
          phase: "HYPOTHESIZE"
          responsibilities:
            - "Analyze edge cases and boundary conditions"
            - "Test hypothesis with extreme inputs"
            - "Identify race conditions or timing issues"
            - "Check error handling paths"

  user_prompt:
    question: "How should agents be dispatched?"
    header: "Dispatch Mode"
    options:
      - id: A
        label: "Single Agent"
        description: "One agent handles all phases (default)"
      - id: B
        label: "Multi-Agent (1+2)"
        description: "1 orchestrator + 2 workers for parallel hypothesis generation"
      - id: C
        label: "Multi-Agent (1+3)"
        description: "1 orchestrator + 3 workers for comprehensive analysis"

  worker_output_format:
    structure: json
    required_fields:
      - phase
      - findings
      - evidence
      - hypothesis
      - confidence
    example: |
      {
        "phase": "ANALYZE",
        "findings": [
          { "finding": "Call path identified", "evidence": "auth.ts:123 -> user.ts:45" }
        ],
        "hypothesis": "Null check missing at auth.ts:125",
        "confidence": "high"
      }

  fallback_behavior:
    worker_timeout_seconds: 60
    on_worker_timeout: "Continue with available hypotheses"
    on_all_workers_fail: "Fall back to single-agent mode"
    on_orchestrator_fail: "Save partial results to scratch/"

# ───────────────────────────────────────────────────────────────────
# CHECKPOINT OPTIONS (Standard)
# ───────────────────────────────────────────────────────────────────
checkpoint_options:
  standard:
    - label: "Approve"
      description: "Approve this step and proceed"
    - label: "Review Details"
      description: "Show more details"
    - label: "Modify"
      description: "Request changes before proceeding"
  
  dispatch:
    - label: "Dispatch"
      description: "Send to debug agent now"
    - label: "Edit Context"
      description: "Modify the handoff context"
    - label: "Cancel"
      description: "Cancel the dispatch"

# ───────────────────────────────────────────────────────────────────
# WORKFLOW ENFORCEMENT (CRITICAL)
# ───────────────────────────────────────────────────────────────────
workflow_enforcement:
  mode: strict
  step_order: sequential_mandatory
  skip_allowed: false

  step_completion_rule: |
    FOR EACH STEP:
    1. Execute ALL activities listed
    2. Present checkpoint to user for approval
    3. Wait for user response
    4. Mark step ✅ in tracking after approval
    5. ONLY THEN proceed to next step
    
    ⛔ NEVER skip a step
    ⛔ NEVER proceed without user approval at checkpoint
    ⛔ NEVER dispatch without user confirmation

  critical_steps:
    step_2_generate_report:
      enforcement: "MUST get user approval before dispatch"
    step_5_integration:
      enforcement: "MUST get user approval before applying fixes"

# ───────────────────────────────────────────────────────────────────
# WORKFLOW (5 STEPS WITH CHECKPOINTS)
# ───────────────────────────────────────────────────────────────────
workflow:
  step_1_validate_context:
    purpose: Confirm all required context is available from phases
    activities:
      - Verify spec_path exists and is accessible
      - Verify error_message is captured
      - Verify affected_files are identified
      - Verify previous_attempts are documented
      - Note reproduction_steps (optional but helpful)
    if_context_missing:
      action: "Report what's missing and request from user"
    checkpoint:
      question: "Step 1 Complete: All context validated. Ready to generate report?"
      options:
        - label: "A) Continue"
          description: "Generate debug-delegation.md"
        - label: "B) Review Context"
          description: "Show all gathered context"
        - label: "C) Add More"
          description: "Provide additional context"
      wait: true
    outputs:
      - context_confirmed: true
    validation: user_approved

  step_2_generate_report:
    purpose: Create debug-delegation.md using template
    template: .opencode/skill/system-spec-kit/templates/debug-delegation.md
    activities:
      - Read template
      - Fill all placeholders with phase outputs
      - Generate task_id as debug-YYYYMMDD-HHMM
      - Classify error_category from error message
      - Document all previous_attempts
      - Add hypothesis about root cause
      - Save file to spec folder or scratch/
    error_categories:
      syntax_error: "Parse errors, unexpected tokens, brackets"
      type_error: "Type mismatch, undefined properties, TS errors"
      runtime_error: "Exceptions during execution, crashes"
      test_failure: "Assertion failures, test timeouts"
      build_error: "Compilation failures, bundling errors"
      lint_error: "Linter errors, code style violations"
      unknown: "Cannot classify from error message"
    save_location:
      with_spec: "[spec_path]/debug-delegation.md"
      ad_hoc: "scratch/debug-delegation.md"
    checkpoint:
      question: "Step 2 Complete: Debug report created. Review before dispatch?"
      display: |
        DEBUG REPORT CREATED
        Location: [path to debug-delegation.md]
        Error Category: [error_category]
        Attempts Documented: [count]
      options:
        - label: "A) Dispatch Now"
          description: "Send to sub-agent immediately"
        - label: "B) Review Report"
          description: "Show full debug-delegation.md content"
        - label: "C) Edit Report"
          description: "Modify before dispatching"
      wait: true
    outputs:
      - debug_delegation_md: "[path to created file]"
    validation: user_approved_dispatch

  step_3_dispatch_subagent:
    purpose: Dispatch @debug agent with structured handoff via Task tool
    agent: "@debug"
    agent_file: ".opencode/agent/debug.md"
    task_parameters:
      description: "Debug: [brief error summary - max 50 chars]"
      subagent_type: "debug"
      prompt: "[sub_agent_prompt_template]"
    sub_agent_prompt_template: |
      # Debug Agent Dispatch

      You are the @debug agent. Execute your 4-phase debugging methodology:
      OBSERVE → ANALYZE → HYPOTHESIZE → FIX

      ## Debug Context Handoff

      ### Error Description
      {error_message}

      ### Files Involved
      {affected_files}

      ### Reproduction Steps
      {reproduction_steps}

      ### Prior Attempts (What Was Tried)
      {previous_attempts}

      ### Environment
      - Model: {selected_model}
      - Spec Folder: {spec_path}

      ## Instructions
      - Follow your 4-phase methodology exactly
      - Form 2-3 ranked hypotheses with evidence
      - Make minimal, targeted fixes
      - Return structured response (Success/Blocked/Escalation format)

      ## Full Debug Report
      {debug_delegation_md_content}
    fallback:
      subagent_type: "general-purpose"  # Claude Code: "general-purpose" | OpenCode: "general"
      fallback_reason: "If @debug agent file unavailable or dispatch fails"

      ### Verification
      1. [Step 1]
      2. [Step 2]
      3. [Step 3]
      
      ### Prevention
      [How to prevent this issue in future]
      
      ### Caveats
      [Any assumptions or uncertainties]
    timeout_ms: 120000
    # No checkpoint here - dispatch happens, then we wait for response
    outputs:
      - sub_agent_dispatched: true
    validation: task_tool_invoked

  step_4_receive_findings:
    purpose: Capture and validate sub-agent response
    activities:
      - Wait for sub-agent response
      - Extract root_cause, proposed_fix, verification_steps, prevention
      - Validate proposed_fix includes file paths and executable code
      - Store findings for integration
    if_response_received:
      extract: [root_cause, proposed_fix, verification_steps, prevention, caveats]
      validate: "proposed_fix includes file paths and executable code"
    if_timeout_or_error:
      action: "Offer retry options (A/B/C)"
      wait: true
    if_needs_more_context:
      action: "Gather additional context and re-dispatch"
    retry_limit: 3
    # Checkpoint is implicit - findings are presented in Step 5
    outputs:
      - findings_received: true
      - root_cause: "[from sub-agent]"
      - proposed_fix: "[from sub-agent]"
    validation: valid_findings_captured

  step_5_integration:
    purpose: Present findings and apply resolution
    activities:
      - Display findings summary to user
      - Present integration options (A/B/C/D)
      - Handle user selection
      - Apply fix if requested (with Gate 3 check)
      - Update debug-delegation.md with resolution
    findings_display: |
      DEBUG FINDINGS
      Root Cause: [summary from sub-agent]
      Proposed Fix: [code snippet preview - first 10 lines]
      Confidence: [HIGH/MEDIUM/LOW]
    checkpoint:
      question: "Step 5: How would you like to proceed with these findings?"
      options:
        - label: "A) Apply the fix"
          description: "I'll make the code changes now"
        - label: "B) Show full details"
          description: "Let me review before deciding"
        - label: "C) Request more investigation"
          description: "This needs deeper analysis"
        - label: "D) Manual review"
          description: "I'll handle it myself"
      wait: true
    integration_options:
      A_apply_fix:
        label: "Apply the fix"
        gate_3_check: "IF ad-hoc mode: Ask spec folder question"
        actions: [make_code_changes, verify_changes, suggest_tests, update_report]
        status: "RESOLVED"
        post_apply_checkpoint:
          question: "Fix applied. Verify it works?"
          options:
            - label: "A) Run tests"
            - label: "B) Manual verify"
            - label: "C) Done"
          wait: true
      B_show_details:
        label: "Show full details"
        actions: [display_full_response, re_ask_for_action]
        wait: true
      C_more_investigation:
        label: "Request more investigation"
        actions: [ask_focus_area, re_dispatch_subagent]
      D_manual_review:
        label: "Manual review"
        actions: [confirm_user_handles, keep_report]
        status: "NEEDS_REVIEW"
    resolution_section: |
      ## 6. RESOLUTION
      **Resolved By:** Sub-agent delegation
      **Resolution Date:** [timestamp]
      **Root Cause:** [from sub-agent]
      **Fix Applied:** [description]
      **Verified:** [yes/no + method]
    outputs:
      - resolution_complete: true
      - status: "[RESOLVED|NEEDS_REVIEW|ESCALATE]"
    validation: user_action_completed

# ───────────────────────────────────────────────────────────────────
# WORKFLOW TERMINATION
# ───────────────────────────────────────────────────────────────────
termination:
  after_step: 5
  message: "Debug delegation completed."
  final_checkpoint:
    question: "Debug workflow complete. What's next?"
    options:
      - label: "A) Verify fix"
        description: "Run tests or check in browser"
      - label: "B) Save context"
        description: "Run /memory:save to preserve insights"
      - label: "C) Continue work"
        description: "Return to original task"
      - label: "D) Done"
        description: "End debugging session"
    wait: true
  next_steps:
    - condition: "Fix applied successfully"
      action: "Verify in browser/tests"
    - condition: "Fix applied, continue work"
      action: "Return to original workflow"
    - condition: "Issue needs more analysis"
      action: "/spec_kit:debug (retry with different model)"
    - condition: "Want to save debugging context"
      action: "/memory:save [spec-folder-path]"
    - condition: "Debugging session complete"
      action: "/spec_kit:handover [spec-folder-path]"

# ───────────────────────────────────────────────────────────────────
# INTERACTIVE EXECUTION GUIDANCE
# ───────────────────────────────────────────────────────────────────
interactive_execution:
  principle: "Execute debug delegation with user approval at each checkpoint"
  checkpoint_behavior:
    - Complete step activities
    - Present findings summary
    - Present options to user for approval
    - Wait for user response
    - Process user feedback
    - Proceed, modify, or cancel as directed
  user_feedback_handling:
    approve: "Proceed to next step"
    review: "Show detailed output of current step"
    modify: "Accept changes and re-execute step"
    cancel: "Stop the debug delegation workflow"

# ───────────────────────────────────────────────────────────────────
# ERROR RECOVERY
# ───────────────────────────────────────────────────────────────────
error_recovery:
  context_incomplete:
    action: "Ask user for additional context"
  report_creation_fails:
    action: "Inform user, offer retry"
  user_cancels:
    action: "Acknowledge cancellation, offer alternatives"
  sub_agent_timeout:
    action: "Present option to retry with same or different model"
  sub_agent_needs_context:
    action: "Gather requested context, re-dispatch with user approval"
  fix_application_fails:
    action: "Present error, offer manual review option"

# ───────────────────────────────────────────────────────────────────
# RULES
# ───────────────────────────────────────────────────────────────────
rules:
  ALWAYS:
    - get_user_approval_at_checkpoints
    - verify_context_from_phases
    - create_debug_delegation_md_before_dispatch
    - confirm_before_dispatch
    - respect_user_decisions
    - check_gate_3_before_applying_fixes_in_adhoc_mode
    - update_debug_delegation_md_with_resolution

  NEVER:
    - dispatch_without_user_approval
    - skip_checkpoints
    - ignore_user_feedback
    - apply_fixes_without_gate_3_check
    - proceed_without_user_confirmation
