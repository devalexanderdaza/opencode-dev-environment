# ───────────────────────────────────────────────────────────────────
# SMART SPECKIT: RESUME WORKFLOW (INTERACTIVE MODE)
# ───────────────────────────────────────────────────────────────────
role: Expert Developer using Smart SpecKit for interactive session resume
purpose: Resume previous work session with user confirmation at each step
action: Detect session, confirm selection, load context, and present options

operating_mode:
  workflow: utility
  workflow_compliance: OPTIONAL
  workflow_execution: interactive
  approvals: step_by_step
  tracking: session_state_detection
  validation: checkpoint_based

resume_philosophy:
  principle: "Context continuity with user control"
  approach: "Detect, confirm, load, proceed"
  mandate: "Restore context with user validation"

# ───────────────────────────────────────────────────────────────────
# USER INPUTS
# ───────────────────────────────────────────────────────────────────
user_inputs:
  spec_folder: |
    [SPEC_FOLDER]
    Optional spec folder path. If empty, auto-detect from:
    1. Most recent memory file in specs/*/memory/

# ─────────────────────────────────────────────────────────────────
# SESSION DETECTION (Stateless - no .spec-active marker)
# ─────────────────────────────────────────────────────────────────
session_detection:
  priority_order:
    1: "CLI argument (explicit path provided)"
    2: "Find most recent memory file in specs/*/memory/"
  
  note: "Stateless architecture - no .spec-active marker file used"
  
  fallback:
    on_no_memory: "Report no active session, suggest /spec_kit:complete"

# ─────────────────────────────────────────────────────────────────
# CONTEXT LOADING PRIORITY (V14.0 - Simplified)
# ─────────────────────────────────────────────────────────────────
context_loading_priority:
  order:
    1: "handover.md (if exists, <24h old)"
    2: "Recent memory/*.md files (contain embedded Project State Snapshot)"
  
  note: "Use handover.md for fast resume"

# ─────────────────────────────────────────────────────────────────
# MEMORY LOADING (INTERACTIVE - prompt for selection)
# ─────────────────────────────────────────────────────────────────
memory_loading:
  mode: interactive
  behavior: |
    In interactive mode, first check for handover.md (<24h old).
    If present, load it first and show contents to user.
    Then prompt the user to select additional memory files
    for context recovery if needed.
  
  options:
    - id: A
      label: "Load most recent memory file"
      description: "Quick context refresh from latest session"
    - id: B
      label: "Load all recent files (up to 3)"
      description: "Comprehensive context from recent sessions"
    - id: C
      label: "List all files and select specific"
      description: "Choose specific memory files to load"
    - id: D
      label: "Skip"
      description: "Start fresh without prior context"
  
  mcp_integration:
    tool: memory_search
    note: "Call MCP tools directly - NEVER through Code Mode"
    query_pattern: "Load context for {spec_folder_name}"

# ─────────────────────────────────────────────────────────────────
# CHECKPOINT OPTIONS
# ─────────────────────────────────────────────────────────────────
checkpoint_options:
  session_selection:
  - label: "Confirm"
    description: "This is the correct spec folder"
  - label: "Select Different"
    description: "Choose a different spec folder"
  - label: "Cancel"
    description: "Cancel resume operation"

  continuation:
  - label: "Continue from pending work"
    description: "Pick up where you left off"
  - label: "Run /spec_kit:implement"
    description: "Execute remaining tasks"
  - label: "Just chat"
    description: "Work on it manually"

# ─────────────────────────────────────────────────────────────────
# STALE SESSION DETECTION (Part of Checkpoint Options)
# ─────────────────────────────────────────────────────────────────
stale_session_detection:
  check: "last_modified > 7 days"
  action: "Present warning and options to user"
  
  interactive_behavior:
    action: "Present options for handling stale session"
    options:
    - label: "Resume anyway"
      description: "Load context and continue"
    - label: "Fresh start"
      description: "Keep artifacts, restart workflow"
    - label: "Review first"
      description: "Show what changed in codebase"
    - label: "Cancel"
      description: "Do not resume"

# ─────────────────────────────────────────────────────────────────
# CONFIDENCE FRAMEWORK - Simplified for Resume
# ─────────────────────────────────────────────────────────────────
confidence_framework:
  purpose: "Ensure session context is valid before resuming work"
  note: "Resume workflow uses simplified confidence checks focused on context validity"
  
  thresholds:
    high:
      range: "80-100%"
      action: "Proceed with context loading and resume"
    medium:
      range: "40-79%"
      action: "Proceed with caution - present stale session options to user"
    low:
      range: "0-39%"
      action: "STOP - Ask user about context reliability before proceeding"
  
  context_validation_scoring:
    factors:
      session_recency:
        weight: 0.40
        description: "How recent is the last session? (<7 days = high, >7 days = low)"
      artifact_completeness:
        weight: 0.30
        description: "Are required artifacts present and valid?"
      memory_availability:
        weight: 0.20
        description: "Are memory files available for context loading?"
      codebase_changes:
        weight: 0.10
        description: "Have relevant files changed since last session?"
  
  clarification_format: |
    "Context confidence is low ([NN%]). How would you like to proceed?
    - A) Resume anyway - Load available context
    - B) Fresh start - Keep artifacts but restart workflow
    - C) Review first - Show what changed since last session
    - D) Cancel - Do not resume"
  
  key_checkpoints:
    - step: 1
      check: "Spec folder path valid and accessible?"
      checkpoint: true
    - step: 2
      check: "User selected memory loading preference?"
      checkpoint: true
    - step: 3
      check: "Memory file loadable and not corrupted?"
    - step: 4
      check: "Progress calculation accurate?"
    - step: 5
      check: "User confirmed continuation approach?"
      checkpoint: true

# ─────────────────────────────────────────────────────────────────
# WORKFLOW (UTILITY - 5 STEPS WITH CHECKPOINTS)
# ─────────────────────────────────────────────────────────────────
workflow:
  step_1_session_detection:
    purpose: Detect active session from CLI argument or memory files
    activities:
    - Check if spec folder provided via CLI argument
    - If no argument, find most recent memory file
    - Validate spec folder exists
    outputs:
    - spec_folder: detected_path
    - detection_method: argument_or_memory
    validation: session_detected
    checkpoint:
      question: "Found session. Is this the correct spec folder?"
      use: present_options_to_user
      options:
      - label: "Confirm"
        description: "This is the correct spec folder"
      - label: "Select Different"
        description: "Choose a different spec folder"
      - label: "Cancel"
        description: "Cancel resume operation"

  step_2_memory_selection:
    purpose: Check for handover.md first, then present memory options
    activities:
    - Check for handover.md in spec_folder (<24h old)
    - If exists, load and display "⚡ Loaded from handover.md"
    - Extract Last Completed, Next Action, Blockers from handover.md
    - Then list memory files in spec_folder/memory/
    - Sort by modification time (most recent first)
    - Memory files contain embedded Project State Snapshot (Phase, Active File, etc.)
    - Present numbered options to user for additional context
    - Wait for user selection
    context_priority:
      1: handover.md
      2: memory/*.md (contains Project State Snapshot)
    outputs:
    - handover_loaded: true|false
    - selected_memory: user_choice
    - load_count: number_of_files
    checkpoint:
      question: "Load additional context?"
      note: "If handover.md was loaded, user may skip additional memory loading"
      use: present_options_to_user
      options:
      - label: "A) Load most recent memory file"
        description: "Quick context refresh"
      - label: "B) Load all recent files (up to 3)"
        description: "Comprehensive context"
      - label: "C) List all files and select specific"
        description: "Choose specific memories"
      - label: "D) Skip"
        description: "Continue with current context only"

  step_3_load_memory:
    purpose: Load selected memory files (in addition to handover.md if loaded)
    activities:
    - Read selected memory file(s) from step 2
    - Merge with handover.md context if already loaded
    - Extract Project State Snapshot (Phase, Active File, Last/Next Action, Blockers)
    - Extract key context (decisions, pending work, next actions)
    - Parse and summarize combined context
    mcp_tool:
      name: memory_search
      note: "Call directly - NEVER through Code Mode. Use includeContent: true to embed memory content in results."
      example: "spec_kit_memory_memory_search({ specFolder: 'xxx', includeContent: true })"
    outputs:
    - memory_loaded: true
    - context_source: handover|memory|combined
    - context_summary: extracted_context
    validation: context_loaded

  step_4_calculate_progress:
    purpose: Calculate task and checklist progress
    activities:
    - Parse tasks.md for completion status
    - Parse checklist.md for verification status
    - Calculate percentages
    - Identify pending items
    outputs:
    - tasks_progress: percentage
    - checklist_progress: percentage
    - pending_items: list
    validation: progress_calculated

  step_5_present_resume:
    purpose: Display resume summary and offer continuation options
    activities:
    - Display spec folder and last activity
    - Show progress bars for tasks and checklist
    - List artifacts status
    - Show pending work summary
    - Show next actions
    - Present continuation options
    outputs:
    - resume_summary: displayed
    validation: resume_complete
    checkpoint:
      question: "Ready to continue. What would you like to do?"
      use: present_options_to_user
      options:
      - label: "Continue from pending work"
        description: "Pick up where you left off"
      - label: "Run /spec_kit:implement"
        description: "Execute remaining implementation tasks"
      - label: "Just chat"
        description: "Work on it manually"

# ─────────────────────────────────────────────────────────────────
# STALE SESSION HANDLING
# ─────────────────────────────────────────────────────────────────
stale_session:
  threshold_days: 7
  
  detection:
    check: "last_modified > 7 days"
    action: "Present warning and options to user"
  
  interactive_behavior:
    action: "Present options for handling stale session"
    options:
    - label: "Resume anyway"
      description: "Load context and continue"
    - label: "Fresh start"
      description: "Keep artifacts, restart workflow"
    - label: "Review first"
      description: "Show what changed in codebase"
    - label: "Cancel"
      description: "Do not resume"

# ─────────────────────────────────────────────────────────────────
# TERMINATION
# ─────────────────────────────────────────────────────────────────
termination:
  after_step: 5
  message: "Session resume complete. Ready to continue work."
  next_steps:
  - Continue from pending work
  - Review implementation summary
  - Run /spec_kit:implement if tasks remain

# ─────────────────────────────────────────────────────────────────
# INTERACTIVE EXECUTION GUIDANCE
# ─────────────────────────────────────────────────────────────────
interactive_execution:
  principle: "Execute resume with user approval at each checkpoint"

  checkpoint_behavior:
  - Complete step activities
  - Present results summary
  - Present options to user for selection
  - Wait for user response
  - Process user feedback
  - Proceed or redirect as directed

  user_feedback_handling:
    confirm: "Proceed to next step"
    select_different: "Show folder selection options"
    skip: "Proceed without loading memory"
    cancel: "Abort resume operation"

# ─────────────────────────────────────────────────────────────────
# ERROR RECOVERY
# ─────────────────────────────────────────────────────────────────
error_recovery:
  no_active_session:
    action: "Report no session found, suggest /spec_kit:complete to start"
  spec_folder_missing:
    action: "Report folder not found, ask user to specify or create"
  memory_search_failed:
    action: "Report error, offer to proceed without context"
  stale_session_detected:
    action: "Present stale session options to user"
  user_cancels:
    action: "Acknowledge cancellation, exit gracefully"

# ─────────────────────────────────────────────────────────────────
# RULES
# ─────────────────────────────────────────────────────────────────
rules:
  ALWAYS:
  - detect_session_before_loading
  - confirm_spec_folder_with_user
  - present_memory_options
  - calculate_progress_from_artifacts
  - display_clear_summary
  - use_mcp_tools_directly
  - respect_user_selections

  NEVER:
  - auto_load_without_confirmation
  - proceed_without_user_approval
  - proceed_without_valid_spec_folder
  - call_mcp_through_code_mode
  - ignore_user_cancellation
